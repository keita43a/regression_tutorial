# パネルデータ分析 {#paneldata}


## パネルデータとは

重回帰分析のセクションで扱ったデータは基本的にはクロスセクションデータであった。
これは、データの変動が人であったり、県であったり、グループであったりするものであり、データでは添字$i$で表現していた。

これに加えて、時間の変動藻ある場合には、クロスセクションデータで分析するよりアドバンテージがある。時間変動がある場合にどのような形になるか見てみよう。

### スクリプトの準備

新しいスクリプトにコードを書いていく。
新しくスクリプトを作成し、`panel_data.R`という名前をつけて保存する。

### パッケージの準備

以下のパッケージを使うので読み込んでおく。
インストールしてない場合は、インストールする。

```{r}
# ライブラリ
library(tidyverse)
library(psych)
library(skimr)
library(AER)
library(fixest)

```



### データの準備

データを読み込む。データ名が長いので、 `data_f`に入れ替えよう。

```{r}
data(Fatalities)

data_f <- Fatalities
```


データの中身を見てみる。
まずは、どんなデータなのか`head()`で確認する。

```{r}
head(data_f)
```

このデータはアメリカの州×年ごとに、様々な変数が記録されているデータである。
どんな変数が記録されているかは、helpファイルを見るとわかる。

```{r}
help(Fatalities)
```


### データの記述統計

データの記述統計を確認しよう。一番基本的なものはsummary()関数を使う方法である。

```{r}
summary(data_f)
```

Chapter \@ref(#rstats)　で説明したように、他のパッケージを使う方法もある。

```{r}
describe(data_f, skew = FALSE)
```

`psych`パッケージの`describe()`では、カテゴリー変数も無理やり数値化して計算するのでおかしなことになっているものがあることである。例えば、stateは州なので、平均や標準偏差が計算されているのはおかしい。
しかし、数値の変数を見るときには有用である。


`skimr`パッケージの`skim()`関数は、カテゴリ変数と連続変数を区別して記述統計を示してくれる。

```{r}
library(skimr)

skim(data_f)
```


### データの加工

データには、交通事故による死亡数`fatal`はあるが、死亡率がない。当然ながら各州によって人口が違い、人口が多い州は死亡数も多くなる。州の間で比較を行うためには、死亡数より死亡率が適切だろう。そこで、死亡率`fatal_rate`を死亡数`fatal`を人口`pop`で割ることで計算する。あまりに小さい数字になるため10000をかけて「１万人当たりの死亡者数」として死亡率を定義する。
新たに追加したデータを`data_f2`に入れる。

```{r}
# データの加工
data_f2 <- data_f |> 
  # 死亡率の計算
  mutate(fatal_rate = fatal/pop * 10000)

```

## パネルデータ分析

### 事例：交通事故死亡率とアルコール税の関係

ここでは、アメリカの州（アラスカとハワイを除いた48州）の1982~1988年のデータを用いて、各州のアルコール税の税率と、交通事故死亡率の関係を分析する。

ここで、日本とは異なる背景知識だが、アメリカは連邦制の国であり、州によって様々な法律が異なる。例えば消費税のない州もあれば、その税率が州で違ったりもする。この場合はアルコール、特にビールにかかる税率が州で異なる点に着目して、税率の違いが酒酔い運転などによっても引き起こされる交通事故死亡率に影響するかどうかを分析する。

州$i$の交通事故死亡率を$y_{i}$とし、ビール税率を$x_{i}$とすると、以下の単回帰式によって、影響が推定できそうだ。

$$
 y_{i} = \alpha + \beta x_{i} +\varepsilon_{i}
$$


ビール税率を上げると交通事故死亡率が下がる、という仮説を検証したい場合、$\beta$が負（マイナス）であると期待するだろう。

まず、この単回帰式を推定するために、クロス・セクションのデータで推定を行ってみよう。
データのうち、1982年と1988年をそれぞれ抽出してみよう。

```{r}
# クロスセクションデータの作成
data_f2_1982 <- data_f2 |> 
  filter(year == 1982)

data_f2_1988 <- data_f2 |> 
  filter(year == 1988)

```

このデータを用いて単位回帰分析を行う。

```{r}

# 回帰分析
# lm()の代わりに feols()を使う

# 1982年のデータ
reg1_1982 <- feols(fatal_rate ~ beertax, data=data_f2_1982)

# 1988年のデータ
reg1_1988 <- feols(fatal_rate ~ beertax, data=data_f2_1988)


```

結果を表示する。

```{r}
etable(reg1_1982,reg1_1988)
```

この結果によれば、1982年ではビール税率が1%上がると、交通事故死亡率が0.1485上昇し、1988年では0.4388上昇する。
このデータは州ごとのクロスセクションデータなので、もう少し正確に解釈すると、ビール税が1%高い州では交通事故死亡率が高い、ということになる。

この結果をグラフでも見てみよう。縦軸を死亡率、横軸をビール税として散布図を描く。ここでは1988年のデータを見てみよう。

```{r}
ggplot(data=data_f2_1988, aes(x=beertax, y=fatal_rate)) + 
  geom_point() +
  geom_smooth(method="lm", se=FALSE)+
  labs(x="ビール税率", y="交通事故死亡率(10000人当たり）") +
  theme_gray(base_family = "HiraKakuPro-W3") #<- このレイヤーはWindowsならいらない
```

むしろ税率と交通事故死亡率には正の関係がある。

このアプローチには問題がないだろうか？なぜなら、クロスセクションデータでは州ごとの違いを見ているので、ビール税が高い州では交通事故死亡率が高いという結果であるが、交通事故死亡率が高い州ではビール税を上げているので高いという可能性もある。州による特性もある。

では時間的な変動を含めたデータでは、どうなるだろうか？

州$i$の年$t$における交通事故死亡率を$y_{it}$とし、ビール税率を$x_{it}$とすると、以下の単回帰式によって、影響が推定できそうだ。上の式と違うのは添字に$t$が加わり、時間の変動も加味したデータを使っていることだ。

$$
 y_{it} = \alpha + \beta x_{it} +\varepsilon_{it}
$$

```{r}

# 回帰分析
# lm()の代わりに feols()を使う

# 1982-1988年のデータ
reg1_panel <- feols(fatal_rate ~ beertax, data=data_f2)


```

結果を表示する。

```{r}
etable(reg1_panel)
```

結果は、$\beta$に当たるパラメータの推定値が0.3646となり、やはり正の符号となっている。
時間変動を加えても結果は変わっていない、ということはやはりビール税を上げると交通事故死亡率が増えるのだろうか？


## 固定効果モデル

ここで、重要なのはデータを変えただけでは本質的な問題である「州の特性によって、死亡率が高い州ほどビール税が高い（上げている）」可能性の影響を推定値から排除できていないことである。

この$x_{it}$には、州によってはビール税が（年にかかわらず）高い、という特性も入ってしまっており、そのデータが推定値に影響している。ならば、その影響を分けて推定することはできないか。これが**固定効果モデル**のアイデアである。

固定効果とは、データとしては直接観察されないが時間的に変化しない主体独特の効果である。この場合は時間的に変化しない州独特の効果と言える。ではデータとしては直接観察されないのに、どうやって回帰式に含めるのか？これは、州ごとのダミー変数を作成するという発想で解決する。

固定効果モデルを式として書くと以下のように書くことができる。

$$
y_{it} = \gamma_{i} + \beta x_{it} + \varepsilon_{it}
$$


切片$\alpha$の代わりに、添え字$i$を持つパラメータ$\gamma$が含まれている。これは州ごとに切片が異なる回帰式とも解釈することができる。ここで、州ごとの(交通事故死亡率の)特性の違いが捕捉されるため、ビール税率の係数の推定値はその州ごとの特性を除いた推定値となる。しかし、データではないパラメータに$i$がついているのはなぜか？

これは実質的には以下のような式を推定しているのと同じである。

$$
 y_{it} = \beta x_{it} + \gamma_{AL} D_{AL} + \gamma_{AZ} D_{AZ} + \gamma_{AR} D_{AR} + \cdots + \gamma_{WY} D_{WY} +  + \varepsilon_{it}
$$

もしデータ$i$がアラバマ州ならば$D_{AL}$は1になり、それ以外は0になるので、$\gamma_{AL}$が式に残る。もし$i$がアリゾナ州ならば$D_{AZ}$は1になり、それ以外は0になる。という形で、$\gamma_{AL}$, $\gamma_{AZ}$ ... $\gamma_{WY}$のワイオミング州までを推定するのである。

実際には、これを`feols`では簡単に推定できる。

```{r}

# |のあとに固定効果として推定したいカテゴリ（今回は州なのでstate)を入れる
reg1_panel_fe = feols(fatal_rate ~ beertax | state, data = data_f2)

etable(reg1_panel, reg1_panel_fe, se = "IID")
```

結果は、固定効果モデル（右）では単位回帰モデル（左）では正だった係数が負になっている。
この結果を解釈すると、「ビール税率が上がると、交通事故死亡率が下がる」という解釈となる。

このように、本当に推定したい効果が、データの特徴によって推定できない場合、それが主体独特の効果である場合は、固定効果モデルを用いることで分別して推定することができる。

しかし、固定効果モデルはパネルデータではないと使うことができない。
たとえば、上で作成したクロスセクションデータで固定効果モデルを推定してみよう。

```{r, error=TRUE}
reg1_panel_fe_1988 <- feols(fatal_rate ~ beertax | state, data=data_f2_1988)
```

エラーが出る。これは、クロスセクションデータでは州ごとの変動しかないため、ダミー変数による固定効果の変動（州によって1か0か）と州ごとのビール税の変動のどちらが交通事故死亡率の変動を説明しているか識別ができないためである。

### 固定効果モデルのビジュアルイメージ

固定効果モデルをビジュアルイメージで理解してみよう。

まず、パネルデータを使って散布図を書いてみよう。

```{r}

ggplot(data=data_f2, aes(x=beertax,y=fatal_rate)) +
  geom_point(size=0.5) +
  labs(x = "ビール税率", y="死亡率") +
  theme_bw(base_family = "HirakakuPro-W3")
```

これだけを見ると、やはり右肩上がりの傾向があるように見える。
`geom_smooth(method="lm")`というレイヤーを加えて、回帰線を描いてみよう。

```{r}

ggplot(data=data_f2, aes(x=beertax,y=fatal_rate)) +
  geom_point(size=0.5) +
  labs(x = "ビール税率", y="死亡率") +
  geom_smooth(method="lm") +
  theme_bw(base_family = "HirakakuPro-W3")
```

やはり右肩あがりになっている。

では、今度は州ごとに色分けしてみよう。`aes()`の中で色カテゴリに州を指定する`col=state`。


```{r}

ggplot(data=data_f2, aes(x=beertax,y=fatal_rate,col=state)) +
  geom_point(size=0.5) +
  labs(x = "ビール税率", y="死亡率") +
  geom_smooth(method="lm", se=FALSE) +
  theme_bw(base_family = "HirakakuPro-W3") +
  theme(legend.position = "none") # <- もし凡例が大きすぎて図が見えない場合はこのレイヤーを追加して凡例を消す

```
すると、州ごと分けた点と線が描かれる。州ごとに見ると、州の中での時間的な変動ではビール税率が高いときに死亡率が下がっている傾向が見られるだろう。このように、州間の違いと州内の違いを分けて推定できるのが固定効果モデルである。
